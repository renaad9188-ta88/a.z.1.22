# ุญู ูุดุงูู ุตูุญุฉ ุงูุฅุฏุงุฑุฉ - ุฏููู ุดุงูู

## ุงููุดุงูู ุงูุดุงุฆุนุฉ ูุงูุญููู

---

## ๐ด ุงููุดููุฉ 1: ุฎุทุฃ 500 ุนูุฏ ูุชุญ ููุญุฉ ุงูุฅุฏุงุฑุฉ

### ุงูุฃุนุฑุงุถ:
- ุฎุทุฃ 500 (Internal Server Error) ุนูุฏ ูุญุงููุฉ ุฌูุจ ุงูุจูุงูุงุช ูู Supabase
- ูุง ุชุธูุฑ ุงูุทูุจุงุช ุฃู ุงูุฅุญุตุงุฆูุงุช

### ุงูุญู:

#### ุงูุฎุทูุฉ 1: ูููุฐ ููู SQL ุงูุฅุตูุงุญู
1. ุงุฐูุจ ุฅูู **Supabase Dashboard** > **SQL Editor**
2. ุงูุชุญ ููู `supabase/FIX_RLS_SIMPLE_FINAL.sql` ุฃู `supabase/FIX_ALL_RLS_FINAL.sql`
3. ุงูุณุฎ **ูู ุงููุญุชูู** ูุงูุตูู ูู SQL Editor
4. ุงุถุบุท **Run**

ูุฐุง ุงูููู ุณูููู ุจู:
- โ ุญุฐู ุงูุชูุฑุงุฑุงุช ูู `profiles`
- โ ุฅุถุงูุฉ UNIQUE constraint
- โ ุญุฐู ุฌููุน ุงูุณูุงุณุงุช ุงููุฏููุฉ
- โ ุฅูุดุงุก ุณูุงุณุงุช ุฌุฏูุฏุฉ ุตุญูุญุฉ
- โ ุฅูุดุงุก profile ูููุณุชุฎุฏู `tamer88@gmail.com` ูุชุนูููู ูุฅุฏุงุฑู

#### ุงูุฎุทูุฉ 2: ุงูุณุญ Cache ุงููุชุตูุญ
1. ุงุถุบุท `Ctrl + Shift + Delete`
2. ุงุฎุชุฑ "Cached images and files"
3. ุงุถุบุท "Clear data"

ุฃู ุงุณุชุฎุฏู **Incognito Mode**: `Ctrl + Shift + N`

#### ุงูุฎุทูุฉ 3: ุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู
1. ุงุฐูุจ ุฅูู `/auth/login`
2. ุงุฎุชุฑ "ุฅูููู (ุฅุฏุงุฑู)"
3. ุฃุฏุฎู `tamer88@gmail.com` ู `123456123`
4. ุงุถุบุท "ุชุณุฌูู ุงูุฏุฎูู"

#### ุงูุฎุทูุฉ 4: ุงุฐูุจ ุฅูู `/admin`
- ูุฌุจ ุฃู ุชุนูู ููุญุฉ ุงูุฅุฏุงุฑุฉ ุงูุขู ุจุฏูู ุฃุฎุทุงุก

---

## ๐ด ุงููุดููุฉ 2: ุฎุทุฃ "ุฎุทุฃ ุดููุน" ูู is_admin()

### ุงูุฃุนุฑุงุถ:
ุนูุฏ ุชูููุฐ `SELECT is_admin()` ุธูุฑ ุฎุทุฃ "ุฎุทุฃ ุดููุน" (Critical Error).

### ุงูุณุจุจ:
ุงูู function `is_admin()` ูุงูุช ุชุณุชุฎุฏู `EXISTS` ูุจุงุดุฑุฉุ ููุฐุง ูุฏ ูุณุจุจ ูุดุงูู ูู ุจุนุถ ุงูุญุงูุงุช.

### ุงูุญู:
ุชู ุฅูุดุงุก ููู ุฌุฏูุฏ `FIX_ADMIN_ACCESS_FINAL_WORKING.sql` ูุน ุชุญุณููุงุช:
- ุฅุถุงูุฉ `STABLE` - ูุฎุจุฑ PostgreSQL ุฃู ุงูู function ูุง ุชุบูุฑ ุงูุจูุงูุงุช
- ุงุณุชุฎุฏุงู `DECLARE` ู `SELECT INTO` - ุจุฏูุงู ูู `EXISTS` ูุจุงุดุฑุฉ
- ุฅุถุงูุฉ `COALESCE` - ููุชุนุงูู ูุน ุงูููู NULL
- ุฅุถุงูุฉ `LIMIT 1` - ูุถูุงู ุฌูุจ ุณุฌู ูุงุญุฏ ููุท
- ุงูุชุญูู ูู `auth.uid() IS NULL` - ูุจู ูุญุงููุฉ ุงููุตูู ููุจูุงูุงุช

### ุฎุทูุงุช ุงูุชูููุฐ:
1. ุงุฐูุจ ุฅูู **Supabase Dashboard** > **SQL Editor**
2. ุงูุชุญ ููู `supabase/FIX_ADMIN_ACCESS_FINAL_WORKING.sql`
3. ุงูุณุฎ **ูู ุงููุญุชูู** ูุงูุตูู
4. ุงุถุบุท **Run**
5. ุงูุณุญ Cache ุงููุชุตูุญ
6. ุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู

---

## ๐ด ุงููุดููุฉ 3: ุนุฏู ุธููุฑ ุงูุจูุงูุงุช ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ

### ุงูุฃุนุฑุงุถ:
- ููุญุฉ ุงูุฅุฏุงุฑุฉ ุชูุชุญ ููู ูุง ุชุธูุฑ:
  - โ ุงูุทูุจุงุช (ูููุง 0)
  - โ ุงูุตูุฑ
  - โ ูุนูููุงุช ุงููุณุชุฎุฏููู
  - โ ุฃุฑูุงู ุงูููุงุชู

### ุงูุญู:

#### ุงูุฎุทูุฉ 1: ูููุฐ ููู SQL ุงูุฅุตูุงุญู
1. ุงุฐูุจ ุฅูู **Supabase Dashboard** > **SQL Editor**
2. ุงูุชุญ ููู `supabase/FIX_ADMIN_ACCESS_COMPLETE.sql`
3. ุงูุณุฎ **ูู ุงููุญุชูู** ูุงูุตูู ูู SQL Editor
4. ุงุถุบุท **Run**

ูุฐุง ุงูููู ุณูููู ุจู:
- โ ุญุฐู ุงูุชูุฑุงุฑุงุช
- โ ุฅุถุงูุฉ UNIQUE constraint
- โ ุญุฐู ุฌููุน ุงูุณูุงุณุงุช ุงููุฏููุฉ
- โ ุฅูุดุงุก function `is_admin()` ุจุงุณุชุฎุฏุงู `SECURITY DEFINER`
- โ ุฅูุดุงุก ุณูุงุณุงุช ุฌุฏูุฏุฉ ุตุญูุญุฉ
- โ ุฅูุดุงุก profile ูููุณุชุฎุฏู `tamer88@gmail.com` ูุฅุฏุงุฑู
- โ ุชูุนูู RLS ุนูู ุงูุฌุฏุงูู

#### ุงูุฎุทูุฉ 2: ุงูุณุญ Cache ุงููุชุตูุญ
1. ุงุถุบุท `Ctrl + Shift + Delete`
2. ุงุฎุชุฑ "Cached images and files"
3. ุงุถุบุท "Clear data"

#### ุงูุฎุทูุฉ 3: ุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู
1. ุงุฐูุจ ุฅูู `/auth/login`
2. ุงุฎุชุฑ "ุฅูููู (ุฅุฏุงุฑู)"
3. ุงูุฅูููู: `tamer88@gmail.com`
4. ูููุฉ ุงููุฑูุฑ: `123456123`
5. ุงุถุบุท "ุชุณุฌูู ุงูุฏุฎูู"

---

## ๐ด ุงููุดููุฉ 4: ุฎุทุฃ "Email signups are disabled"

### ุงูุฃุนุฑุงุถ:
ุนูุฏ ูุญุงููุฉ ุงูุชุณุฌููุ ูุธูุฑ ุงูุฎุทุฃ: **"Email signups are disabled"**

### ุงูุญู:

#### ุงูุฎุทูุฉ 1: ุงุฐูุจ ุฅูู Supabase Dashboard
```
https://supabase.com/dashboard/project/dcnywvixlcysalzfchye/auth/providers
```

#### ุงูุฎุทูุฉ 2: ูู ุตูุญุฉ "Sign In / Providers"
- ุงุจุญุซ ุนู ูุณู **"Email"** ุฃู **"Email Auth"**
- ุชุฃูุฏ ูู ุฃู **"Enable email signup"** ููุนู (ON) โ
- ุชุฃูุฏ ูู ุฃู **"Enable email confirmations"** ูุนุทู (OFF) โ

#### ุงููุณุงุฑ ุงููุงูู:
```
Supabase Dashboard
  โโโ Authentication (ูู ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ)
      โโโ CONFIGURATION
          โโโ Sign In / Providers  โ ุงุถุบุท ููุง
              โโโ Email Auth
                  โโโ Enable email signup: ON โ (ูุฌุจ ุฃู ูููู ููุนู)
                  โโโ Enable email confirmations: OFF โ (ูุฌุจ ุฃู ูููู ูุนุทู)
```

#### ุงูุฅุนุฏุงุฏุงุช ุงููุทููุจุฉ:
| ุงูุฅุนุฏุงุฏ | ุงูุญุงูุฉ ุงููุทููุจุฉ |
|---------|-----------------|
| **Enable email signup** | โ ON (ููุนู) |
| **Enable email confirmations** | โ OFF (ูุนุทู) |

---

## ๐ด ุงููุดููุฉ 5: ุตูุฑ ุงูุฌูุงุฒุงุช ูุง ุชุธูุฑ

### ุงูุฃุนุฑุงุถ:
ุตูุฑ ุงูุฌูุงุฒุงุช ูุง ุชุธูุฑ ูู ููุญุฉ ุงูุฅุฏุงุฑุฉ ูุน ุฑุณุงูุฉ ุฎุทุฃ ูู ุงููููุณูู:
```
StorageApiError: Object not found
```

### ุงูุณุจุจ:
1. ุงูุตูุฑ ุชูุญูุธ ูู public URLs ููู ุงูู bucket ุบูุฑ public
2. ูุญุงููุฉ ุฅูุดุงุก signed URLs ุชูุดู ูุฃู ุงููููุงุช ุบูุฑ ููุฌูุฏุฉ ุฃู ุงููุณุงุฑุงุช ุบูุฑ ุตุญูุญุฉ
3. ุณูุงุณุงุช RLS ุชููุน ุงูุฅุฏูู ูู ุฑุคูุฉ ุตูุฑ ุงููุณุชุฎุฏููู ุงูุขุฎุฑูู

### ุงูุญู:

#### ุงูุฎุทูุฉ 1: ุชูููุฐ SQL Script
1. ุงูุชุญ Supabase Dashboard
2. ุงุฐูุจ ุฅูู SQL Editor
3. ุงูุณุฎ ูุญุชูู `supabase/ADD_ADMIN_STORAGE_POLICY.sql`
4. ูููุฐ ุงูุณูุฑูุจุช

#### ุงูุฎุทูุฉ 2: ุงูุชุญูู ูู ุงูุตูุฑ
1. ุชุฃูุฏ ูู ุฃู ุงูุตูุฑ ููุฌูุฏุฉ ูู Supabase Storage
2. ุชุญูู ูู ุฃู bucket `passports` ููุฌูุฏ
3. ุชุญูู ูู ุฃู ุงูุตูุฑ ูุญููุธุฉ ุจุงููุณุงุฑ ุงูุตุญูุญ: `user_id/filename`

#### ุงูุฎุทูุฉ 3: ุงุฎุชุจุงุฑ
1. ุณุฌูู ุงูุฏุฎูู ูุฅุฏูู
2. ุงูุชุญ ุฃู ุทูุจ
3. ุชุญูู ูู ุธููุฑ ุตูุฑ ุงูุฌูุงุฒุงุช

---

## ๐ด ุงููุดููุฉ 6: ุฎุทุฃ constraint trip_status

### ุงูุฃุนุฑุงุถ:
ุนูุฏ ูุญุงููุฉ ุญุฌุฒ ููุนุฏ ุงูุฑุญูุฉุ ูุธูุฑ ุงูุฎุทุฃ:
```
new row for relation "visit_requests" violates check constraint "visit_requests_trip_status_check"
```

### ุงูุณุจุจ:
- constraint `trip_status` ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุง ูุณูุญ ุจุงูููู ุงููุฑุณูุฉ
- ุฃู ุฃู constraint ูู ูุชู ุชุญุฏูุซู ุจุดูู ุตุญูุญ ุจุนุฏ ุฅุถุงูุฉ ุงูุญููู ุงูุฌุฏูุฏุฉ

### ุงูุญู:

#### ุงูุฎุทูุฉ 1: ุชูููุฐ SQL Script ููุฅุตูุงุญ
1. ุงูุชุญ Supabase Dashboard
2. ุงุฐูุจ ุฅูู SQL Editor
3. ูููุฐ ูุญุชูู ููู `supabase/FIX_TRIP_STATUS_CONSTRAINT.sql`

ูุฐุง ุงูุณูุฑูุจุช:
- ูุญุฐู constraint ุงููุฏูู
- ูุญุฏูุซ ุงูููู null ุฅูู ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ
- ูุถูู constraint ุฌุฏูุฏ ูุณูุญ ุจู null ูุงูููู ุงููุทููุจุฉ

#### ุงูููู ุงููุณููุญุฉ ูู trip_status:
- `pending_arrival`: ูู ุงูุชุธุงุฑ ุงููุฏูู
- `scheduled_pending_approval`: ุญุฌุฒ ุจุงูุชุธุงุฑ ุงูููุงููุฉ
- `arrived`: ุชู ุงููุฏูู
- `completed`: ุงูุชูุช ุงูุฑุญูุฉ
- `null`: ูุณููุญ (ุณูุชู ุชุญุฏูุซู ุชููุงุฆูุงู ุฅูู 'pending_arrival')

---

## ๐ด ุงููุดููุฉ 7: ุฎุทุฃ Supabase Client

### ุงูุฃุนุฑุงุถ:
ุฎุทุฃ: "Your project's URL and Key are required to create a Supabase client!"

### ุงูุญู:

#### ุงูุฎุทูุฉ 1: ุชุฃูุฏ ูู ูุฌูุฏ ููู `.env.local`
ุฃูุดุฆ ููู `.env.local` ูู ุงููุฌูุฏ ุงูุฑุฆูุณู ูููุดุฑูุน (ููุณ ูุณุชูู `package.json`)

#### ุงูุฎุทูุฉ 2: ุฃุถู ุงููุญุชูู ุงูุชุงูู:
```env
NEXT_PUBLIC_SUPABASE_URL=https://dcnywvixlcysalzfchye.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRjbnl3dml4bGN5c2FsemZjaHllIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMTgxMzAsImV4cCI6MjA4Mzc5NDEzMH0.IpOCivcWhnDwTTNVs7PcCVLP6x7W9FIc26Ue32-lqSA
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=AIzaSyBA7deUC6nBRAtMfMrjZvjOqRnAlrEeVy4
```

#### ุงูุฎุทูุฉ 3: ุฃุนุฏ ุชุดุบูู ุงูุฎุงุฏู
**ููู ุฌุฏุงู**: ูุฌุจ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู ุจุนุฏ ุฅุถุงูุฉ/ุชุนุฏูู ููู `.env.local`
```bash
# ุฃููู ุงูุฎุงุฏู (Ctrl+C)
# ุซู ุดุบูู ูุฑุฉ ุฃุฎุฑู
npm run dev
```

---

## ๐ ุงูุชุญูู ูู ุงููุฌุงุญ

ุจุนุฏ ุชูููุฐ ุฃู ุญูุ ููููู ุงูุชุญูู:

### 1. ุงูุชุญูู ูู ุงููุณุชุฎุฏููู ุงูุฅุฏุงุฑููู:
```sql
SELECT p.user_id, p.full_name, p.role, u.email
FROM profiles p
LEFT JOIN auth.users u ON u.id = p.user_id
WHERE p.role = 'admin';
```

### 2. ุงูุชุญูู ูู ุงูุณูุงุณุงุช:
```sql
SELECT tablename, policyname, cmd
FROM pg_policies 
WHERE tablename IN ('profiles', 'visit_requests')
ORDER BY tablename, policyname;
```

### 3. ุงูุชุญูู ูู ุนุฏุฏ ุงูุทูุจุงุช:
```sql
SELECT COUNT(*) as total_requests FROM visit_requests;
```

### 4. ุงุฎุชุจุงุฑ function is_admin():
```sql
SELECT is_admin() as is_admin_result;
```

---

## ๐ ููุงุญุธุงุช ูููุฉ

1. **SECURITY DEFINER**: ุงูู functions ุงูุชู ุชุณุชุฎุฏู `SECURITY DEFINER` ุชุนูู ุจุตูุงุญูุงุช ุงููุงูู (postgres)ุ ูููุณ ุจุตูุงุญูุงุช ุงููุณุชุฎุฏู ุงูุญุงููุ ููุง ูุณูุญ ููุง ุจุงูุชุญูู ูู `profiles` ุจุฏูู ูุดุงูู RLS.

2. **Cache ุงููุชุตูุญ**: ุฏุงุฆูุงู ุงูุณุญ Cache ุงููุชุตูุญ ุจุนุฏ ุฃู ุชุบููุฑ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช.

3. **ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู**: ุจุนุฏ ุฃู ุชุนุฏูู ุนูู `.env.local` ูุฌุจ ุฅุนุงุฏุฉ ุชุดุบูู ุงูุฎุงุฏู.

4. **ุงููููุงุช ุงููููุฉ**:
   - `FIX_RLS_SIMPLE_FINAL.sql` - ุงูุฅุตูุงุญ ุงูุฃุณุงุณู
   - `FIX_ADMIN_ACCESS_COMPLETE.sql` - ุฅุตูุงุญ ุดุงูู
   - `FIX_ADMIN_ACCESS_FINAL_WORKING.sql` - ุฅุตูุงุญ function is_admin()
   - `ADD_ADMIN_STORAGE_POLICY.sql` - ุฅุตูุงุญ ุนุฑุถ ุงูุตูุฑ
   - `FIX_TRIP_STATUS_CONSTRAINT.sql` - ุฅุตูุงุญ constraint trip_status

---

## โ๏ธ ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ

1. ุชุฃูุฏ ูู ุชูููุฐ ููู SQL **ุจุงููุงูู**
2. ุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู `tamer88@gmail.com` ููุฌูุฏ ูู `auth.users`
3. ุชุฃูุฏ ูู ุฃู profile ููุฌูุฏ ูู `profiles` ูุน `role = 'admin'`
4. ุงูุณุญ Cache ุงููุชุตูุญ ุชูุงูุงู
5. ุฃุนุฏ ุชุดุบูู ุงูุฎุงุฏู (`npm run dev`)
6. ุณุฌูู ุงูุฏุฎูู ูุฑุฉ ุฃุฎุฑู
7. ุงูุชุญ Console ูู ุงููุชุตูุญ (F12) ูุงุจุญุซ ุนู ุงูุฃุฎุทุงุก

---

**ุฑุงุจุท ููุญุฉ ุงูุฅุฏุงุฑุฉ:** `http://localhost:3000/admin`
