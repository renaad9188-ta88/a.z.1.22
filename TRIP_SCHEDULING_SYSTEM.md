# نظام حجز مواعيد الرحلة

## نظرة عامة
تم إضافة نظام شامل لحجز مواعيد القدوم والمغادرة للطلبات المقبولة.

## الميزات

### 1. حجز موعد الرحلة
- بعد الموافقة على الطلب، يظهر زر "حجز موعد الرحلة" في لوحة الإدارة
- أيام القدوم المتاحة: **الأحد، الثلاثاء، الخميس**
- أيام المغادرة المتاحة: **السبت، الاثنين، الأربعاء**
- تاريخ المغادرة يُحسب تلقائياً: **شهر من تاريخ القدوم**

### 2. إدارة حالة الرحلة
- **pending_arrival**: في انتظار القدوم
- **arrived**: تم القدوم
- **completed**: انتهت الرحلة (بعد شهر من القدوم)

### 3. إغلاق الطلبات تلقائياً
- بعد انتهاء مدة الإقامة (شهر من القدوم)، يتم تحديث حالة الطلب إلى "منتهي"
- يمكن للمستخدم عرض الطلبات المنتهية وحذفها

## الخطوات المطلوبة

### 1. تنفيذ SQL Script
```sql
-- انظر ملف: supabase/ADD_TRIP_SCHEDULING_FIELDS.sql
```

هذا السكريبت يضيف:
- `arrival_date`: تاريخ القدوم
- `departure_date`: تاريخ المغادرة
- `trip_status`: حالة الرحلة
- تحديث constraint للحالة لتشمل 'completed'
- دالة لتحديث حالة الطلب تلقائياً

### 2. استخدام النظام

#### في لوحة الإدارة:
1. بعد الموافقة على طلب، اضغط على زر "حجز موعد الرحلة"
2. اختر تاريخ القدوم من القائمة (أحد، ثلاثاء، خميس)
3. سيتم حساب تاريخ المغادرة تلقائياً (شهر من القدوم)
4. احفظ الموعد

#### في لوحة المستخدم:
1. يمكن للمستخدم رؤية تاريخ القدوم والمغادرة في طلباته
2. الطلبات المنتهية تظهر بحالة "منتهي"
3. يمكن حذف الطلبات المنتهية

## الملفات المضافة/المعدلة

### ملفات جديدة:
- `components/admin/TripSchedulingModal.tsx`: مكون حجز موعد الرحلة
- `supabase/ADD_TRIP_SCHEDULING_FIELDS.sql`: SQL script لإضافة الحقول

### ملفات معدلة:
- `components/admin/types.ts`: إضافة الحقول الجديدة
- `components/admin/RequestCard.tsx`: إضافة زر حجز الموعد
- `components/AdminDashboard.tsx`: ربط مكون حجز الموعد
- `components/DashboardContent.tsx`: عرض معلومات القدوم/المغادرة وإمكانية الحذف

## ملاحظات مهمة

1. **تحديث تلقائي للحالة**: يمكن إعداد cron job في Supabase لتشغيل دالة `update_trip_status_after_departure()` يومياً لتحديث الطلبات المنتهية تلقائياً.

2. **الأيام المتاحة**: 
   - القدوم: الأحد (0)، الثلاثاء (2)، الخميس (4)
   - المغادرة: السبت (6)، الاثنين (1)، الأربعاء (3)

3. **مدة الإقامة**: شهر واحد من تاريخ القدوم (30 يوم)

4. **حذف الطلبات**: يمكن للمستخدم حذف الطلبات المنتهية فقط



